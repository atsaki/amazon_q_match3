name: PR Quality Check

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  quality-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.13

    - name: Install dependencies
      run: uv sync

    - name: Run Ruff Linter
      run: |
        echo "ğŸ” Running Ruff Linter..."
        uv run ruff check . --output-format=github

    - name: Run Ruff Formatter Check
      run: |
        echo "ğŸ¨ Checking code formatting..."
        uv run ruff format --check .

    - name: Run Tests
      run: |
        echo "ğŸ§ª Running test suite..."
        uv run pytest tests/ -v --tb=short

    - name: Run Tests with Coverage
      run: |
        echo "ğŸ“Š Running tests with coverage..."
        uv run pytest tests/ --cov=src/amazon_q_match3 --cov-report=term-missing --cov-report=xml

    - name: Comment PR with Coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          // Read coverage report if it exists
          let coverageComment = '## ğŸ“Š Test Coverage Report\n\n';

          try {
            // This is a simple approach - in a real scenario you might want to parse the XML
            coverageComment += 'âœ… Coverage report generated successfully\n';
            coverageComment += 'ğŸ“ˆ Check the logs above for detailed coverage information\n\n';
          } catch (error) {
            coverageComment += 'âŒ Could not generate coverage report\n\n';
          }

          coverageComment += '## ğŸ” Quality Checks\n\n';
          coverageComment += '- âœ… Ruff Linter\n';
          coverageComment += '- âœ… Ruff Formatter\n';
          coverageComment += '- âœ… pytest Test Suite\n';
          coverageComment += '- âœ… Coverage Analysis\n\n';
          coverageComment += 'ğŸ‰ All quality checks passed!';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: coverageComment
          });

    - name: Set PR Status
      if: success()
      run: |
        echo "âœ… All quality checks passed!"
        echo "PR is ready for review ğŸš€"

    - name: Fail on Quality Issues
      if: failure()
      run: |
        echo "âŒ Quality checks failed!"
        echo "Please fix the issues before merging."
        exit 1
